name: Windows Build

on:
  workflow_dispatch:
  push:
    branches:
      - main

permissions: write-all

env:
  CARGO_INCREMENTAL: 0
  RUST_BACKTRACE: short

jobs:
  windows-build:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-pc-windows-msvc
            arch: x64

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Rust Stable
        uses: dtolnay/rust-toolchain@stable

      - name: Add Rust Target
        run: rustup target add ${{ matrix.target }}

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
          cache-all-crates: true

      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - uses: pnpm/action-setup@v4
        name: Install pnpm
        with:
          run_install: false

      - name: Pnpm install and check
        run: |
          pnpm i
          pnpm check ${{ matrix.target }}

      - name: Tauri build
        uses: tauri-apps/tauri-action@v0
        env:
          NODE_OPTIONS: "--max_old_space_size=4096"
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tauriScript: pnpm
          args: --target ${{ matrix.target }}

      - name: Create Portable Bundle
        run: |
          $version = (Get-Content package.json | ConvertFrom-Json).version
          $targetDir = "src-tauri/target/${{ matrix.target }}/release"
          $portableDir = "Clash Verge_${version}_${{ matrix.arch }}_portable"

          # Create portable directory
          New-Item -ItemType Directory -Force -Path $portableDir

          # Copy main exe
          Copy-Item "$targetDir/clash-verge.exe" "$portableDir/"

          # Copy resources if exists
          if (Test-Path "$targetDir/resources") {
            Copy-Item -Recurse "$targetDir/resources" "$portableDir/"
          }

          # Create portable marker file
          New-Item -ItemType File -Path "$portableDir/.portable" -Force

          # Create zip
          Compress-Archive -Path $portableDir -DestinationPath "${portableDir}.zip" -Force

          # Cleanup
          Remove-Item -Recurse -Force $portableDir

      - name: Get Version
        id: version
        run: |
          $version = (Get-Content package.json | ConvertFrom-Json).version
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-${{ matrix.arch }}
          path: |
            src-tauri/target/${{ matrix.target }}/release/bundle/nsis/*.exe
            Clash Verge_*_portable.zip

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.VERSION }}
          name: "Clash Verge v${{ steps.version.outputs.VERSION }}"
          body: "Windows build with installer and portable version."
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}
          files: |
            src-tauri/target/${{ matrix.target }}/release/bundle/nsis/*.exe
            Clash Verge_*_portable.zip
